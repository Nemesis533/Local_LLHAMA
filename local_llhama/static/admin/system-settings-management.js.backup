/**
 * System Settings Management Module
 * Handles system-wide settings including safety features
 */

import { showError, showSuccess } from './utils.js';

let systemSettingsData = {};
let availableGpus = [];

/**
 * Load available GPUs from server
 */
async function loadAvailableGpus() {
    try {
        const response = await fetch('/settings/available-gpus');
        const data = await response.json();
        
        if (data.status === 'ok') {
            availableGpus = data.gpus;
            populateGpuDropdown();
            return true;
        } else {
            console.error('Failed to load available GPUs:', data.message);
            return false;
        }
    } catch (error) {
        console.error('Failed to load available GPUs:', error.message);
        return false;
    }
}

/**
 * Populate GPU dropdown with detected devices
 */
function populateGpuDropdown() {
    const cudaSelect = document.getElementById('cuda-device');
    if (!cudaSelect) return;
    
    // Clear existing options
    cudaSelect.innerHTML = '';
    
    // Add all available GPUs
    availableGpus.forEach(gpu => {
        const option = document.createElement('option');
        option.value = gpu.id;
        option.textContent = gpu.name;
        cudaSelect.appendChild(option);
    });
}

/**
 * Load system settings from server
 */
export async function loadSystemSettings() {
    try {
        const response = await fetch('/settings/system-settings');
        const data = await response.json();
        
        if (data.status === 'ok') {
            systemSettingsData = data.settings;
            return true;
        } else {
            showError('Failed to load system settings: ' + data.message);
            return false;
        }
    } catch (error) {
        showError('Failed to load system settings: ' + error.message);
        return false;
    }
}

/**
 * Display system settings in the UI
 */
export async function displaySystemSettings() {
    // Load data if not already loaded
    if (Object.keys(systemSettingsData).length === 0) {
        const loaded = await loadSystemSettings();
        if (!loaded) return;
    }
    
    // Load available GPUs and populate dropdown
    await loadAvailableGpus();
    
    // Update safety prompt checkbox
    const safetyEnabled = systemSettingsData.safety?.safety_prompt_enabled?.value ?? true;
    const checkbox = document.getElementById('safety-prompt-enabled');
    if (checkbox) {
        checkbox.checked = safetyEnabled;
    }
    
    // Update max full conversations
    const maxConversations = systemSettingsData.chat?.max_full_conversations?.value ?? 10;
    const maxConversationsInput = document.getElementById('max-full-conversations');
    if (maxConversationsInput) {
        maxConversationsInput.value = maxConversations;
    }
    
    // Update history exchanges
    const historyExchanges = systemSettingsData.chat?.history_exchanges?.value ?? 3;
    const historyExchangesInput = document.getElementById('history-exchanges');
    if (historyExchangesInput) {
        historyExchangesInput.value = historyExchanges;
    }
    
    // Update CUDA device - set value after GPU dropdown is populated
    const cudaDevice = systemSettingsData.hardware?.cuda_device?.value ?? 'auto';
    const cudaSelect = document.getElementById('cuda-device');
    if (cudaSelect) {
        cudaSelect.value = cudaDevice;
    }
    
    // Update Home Assistant allowed domains
    const allowedDomains = systemSettingsData.home_assistant?.allowed_domains?.value ?? [];
    const domainsTextarea = document.getElementById('ha-allowed-domains');
    if (domainsTextarea) {
        domainsTextarea.value = allowedDomains.join(', ');
    }
    
    // Update Home Assistant allowed entities
    const allowedEntities = systemSettingsData.home_assistant?.allowed_entities?.value ?? [];
    const entitiesTextarea = document.getElementById('ha-allowed-entities');
    if (entitiesTextarea) {
        entitiesTextarea.value = allowedEntities.join(', ');
    }
    
    // Update Home Assistant exclusion patterns
    const exclusionDict = systemSettingsData.home_assistant?.exclusion_dict?.value ?? {};
    const exclusionsTextarea = document.getElementById('ha-exclusion-patterns');
    if (exclusionsTextarea) {
        // Convert dict to comma-separated values
        exclusionsTextarea.value = Object.values(exclusionDict).join(', ');
    }
}

/**
 * Toggle safety prompt setting
 */
export function toggleSafety(enabled) {
    if (!systemSettingsData.safety) {
        systemSettingsData.safety = {
            description: "Safety and content moderation settings"
        };
    }
    
    if (!systemSettingsData.safety.safety_prompt_enabled) {
        systemSettingsData.safety.safety_prompt_enabled = {
            description: "Enable or disable the safety instruction prompt"
        };
    }
    
    systemSettingsData.safety.safety_prompt_enabled.value = enabled;
    console.log('Safety prompt toggled:', enabled);
}

/**
 * Update max full conversations setting
 */
export function updateMaxFullConversations(value) {
    if (!systemSettingsData.chat) {
        systemSettingsData.chat = {
            description: "Chat and conversation management settings"
        };
    }
    
    if (!systemSettingsData.chat.max_full_conversations) {
        systemSettingsData.chat.max_full_conversations = {
            description: "Maximum number of recent conversations to load fully"
        };
    }
    
    systemSettingsData.chat.max_full_conversations.value = parseInt(value, 10);
    console.log('Max full conversations updated:', value);
}

/**
 * Update history exchanges setting
 */
export function updateHistoryExchanges(value) {
    if (!systemSettingsData.chat) {
        systemSettingsData.chat = {
            description: "Chat and conversation management settings"
        };
    }
    
    if (!systemSettingsData.chat.history_exchanges) {
        systemSettingsData.chat.history_exchanges = {
            description: "Number of recent user-assistant exchanges to keep in memory"
        };
    }
    
    systemSettingsData.chat.history_exchanges.value = parseInt(value, 10);
    console.log('History exchanges updated:', value);
}

/**
 * Update CUDA device setting
 */
export function updateCudaDevice(value) {
    if (!systemSettingsData.hardware) {
        systemSettingsData.hardware = {
            description: "Hardware and GPU configuration settings"
        };
    }
    
    if (!systemSettingsData.hardware.cuda_device) {
        systemSettingsData.hardware.cuda_device = {
            description: "CUDA device to use for GPU acceleration"
        };
    }
    
    systemSettingsData.hardware.cuda_device.value = value;
    console.log('CUDA device updated:', value);
}

/**
 * Update Home Assistant allowed domains
 */
export function updateHaAllowedDomains(value) {
    if (!systemSettingsData.home_assistant) {
        systemSettingsData.home_assistant = {
            description: "Home Assistant integration configuration"
        };
    }
    
    if (!systemSettingsData.home_assistant.allowed_domains) {
        systemSettingsData.home_assistant.allowed_domains = {
            description: "List of Home Assistant device domains that are allowed to be controlled"
        };
    }
    
    // Convert comma-separated string to array
    const domains = value.split(',').map(d => d.trim()).filter(d => d.length > 0);
    systemSettingsData.home_assistant.allowed_domains.value = domains;
    console.log('HA allowed domains updated:', domains);
}

/**
 * Update Home Assistant allowed entities
 */
export function updateHaAllowedEntities(value) {
    if (!systemSettingsData.home_assistant) {
        systemSettingsData.home_assistant = {
            description: "Home Assistant integration configuration"
        };
    }
    
    if (!systemSettingsData.home_assistant.allowed_entities) {
        systemSettingsData.home_assistant.allowed_entities = {
            description: "Explicit list of entity IDs that are allowed to be controlled"
        };
    }
    
    // Convert comma-separated string to array
    const entities = value.split(',').map(e => e.trim()).filter(e => e.length > 0);
    systemSettingsData.home_assistant.allowed_entities.value = entities;
    console.log('HA allowed entities updated:', entities);
}

/**
 * Update Home Assistant exclusion patterns
 */
export function updateHaExclusionDict(value) {
    if (!systemSettingsData.home_assistant) {
        systemSettingsData.home_assistant = {
            description: "Home Assistant integration configuration"
        };
    }
    
    if (!systemSettingsData.home_assistant.exclusion_dict) {
        systemSettingsData.home_assistant.exclusion_dict = {
            description: "Dictionary of entity name patterns to exclude from device discovery"
        };
    }
    
    // Convert comma-separated string to dict with auto-generated keys
    const patterns = value.split(',').map(p => p.trim()).filter(p => p.length > 0);
    const exclusionDict = {};
    patterns.forEach((pattern, index) => {
        exclusionDict[`exclude_name${index + 1}`] = pattern;
    });
    systemSettingsData.home_assistant.exclusion_dict.value = exclusionDict;
    console.log('HA exclusion dict updated:', exclusionDict);
}

/**
 * Save system settings to server
 */
export async function saveSystemSettings() {
    const statusDiv = document.getElementById('system-settings-save-status');
    
    try {
        statusDiv.style.display = 'block';
        statusDiv.style.color = '#666';
        statusDiv.textContent = 'Saving system settings...';
        
        const response = await fetch('/settings/system-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                settings: systemSettingsData
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'ok') {
            showSuccess('System settings saved successfully!');
            statusDiv.style.color = '#4CAF50';
            statusDiv.textContent = '✓ Saved successfully';
            
            // Hide status after 3 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        } else {
            showError('Failed to save system settings: ' + data.message);
            statusDiv.style.color = '#f44336';
            statusDiv.textContent = '✗ Failed to save';
        }
    } catch (error) {
        showError('Failed to save system settings: ' + error.message);
        statusDiv.style.color = '#f44336';
        statusDiv.textContent = '✗ Error: ' + error.message;
    }
}

// Export for global access
window.systemSettingsManagement = {
    loadSystemSettings,
    displaySystemSettings,
    toggleSafety,
    saveSystemSettings
};
